def count_hallucinations(input_ws: Worksheet, session_id: str) -> int:
    hdr = [c.value for c in input_ws[1]]
    try:
        sid_idx = hdr.index(SESSION_ID_COL_NAME)
        hall_idx = hdr.index(HALLUCINATION_COL_NAME)
    except ValueError:
        return 0
    cnt = 0
    for row in input_ws.iter_rows(min_row=2, values_only=True):
        if row[sid_idx] == session_id and row[hall_idx]:
            cnt += 1
    return cnt

def add_hallucination_column(metrics_ws: Worksheet, input_ws: Worksheet) -> None:
    hdr_font = Font(name="Aptos Narrow", size=9, bold=True)
    body_font = Font(name="Aptos Narrow", size=9)
    align = Alignment(horizontal="left", vertical="center")

    col = metrics_ws.max_column + 1
    metrics_ws.cell(row=1, column=col, value=HALLUCINATION_COL_NAME).font = hdr_font

    for r in range(2, metrics_ws.max_row + 1):
        if metrics_ws.cell(row=r, column=3).value == ENTIRE_COL_NAME:
            sid = metrics_ws.cell(row=r, column=2).value
            v = count_hallucinations(input_ws, sid)
            cell = metrics_ws.cell(row=r, column=col, value=v)
            cell.font = body_font
            cell.alignment = align

    metrics_ws.column_dimensions[get_column_letter(col)].width = 12
    metrics_ws.auto_filter.ref = f"A1:{get_column_letter(col)}{metrics_ws.max_row}"