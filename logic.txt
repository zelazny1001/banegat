# worksheet_writer.py

from __future__ import annotations
from typing import Optional
from openpyxl import Workbook
from openpyxl.worksheet.worksheet import Worksheet
from openpyxl.styles import Font, Alignment, PatternFill
from data_models import MetricsRow, SummaryData
from styling import THIN_BORDER

#=== start modification for summary toxic% - worksheet_writer.py
from constants import (
  METRICS_WORKSHEET_NAME,
  METADATA_COL_NAME,
  SESSION_ID_COL_NAME,
  SECTION_COL_NAME,
  GT_SECTION_TEXT_COL_NAME,
  MODEL_SECTION_TEXT_COL_NAME,
  WER_COL_NAME,
  HALLUCINATION_COUNT_COL_NAME,
  GT_TOKS_COL_NAME,
  MODEL_TOKS_COL_NAME,
  HALLUCINATION_PERCENT_COL_NAME,
  HALLUCINATION_COL_NAME,
  TOXIC_COL_NAME,
  TOXIC_PERCENT_COL_NAME,
  CALL_LEVEL_BKGND_COLOR,
  SAMPLE_LEVEL_BKGND_COLOR,
  AVERAGE_WER_COL_NAME,
  SESSION_COUNT_COL_NAME,
  AVG_HALLUCINATION_PERCENT_COL_NAME,
  AVG_TOXIC_PERCENT_COL_NAME,
  CALL_LEVEL_GRANULARITY,
  DURATION_COL_NAME,
  TRANSCRIPT_DENSITY_COL_NAME,
  AVERAGE_TRX_DENSITY_COL_NAME
)
#=== end modification for summary toxic%

class MetricsWorksheetWriter:
  def __init__(self, workbook: Workbook):
    self.workbook = workbook
    self.worksheet: Optional[Worksheet] = None

  def create_worksheet(self) -> Worksheet:
    if METRICS_WORKSHEET_NAME in self.workbook.sheetnames:
      del self.workbook[METRICS_WORKSHEET_NAME]
    self.worksheet = self.workbook.create_sheet(METRICS_WORKSHEET_NAME)
    self._write_header()
    return self.worksheet

  # === start modification for toxic columns - worksheet_writer.py
  def _write_header(self) -> None:
    headers = [
      METADATA_COL_NAME,
      SESSION_ID_COL_NAME,
      SECTION_COL_NAME,
      GT_SECTION_TEXT_COL_NAME,
      MODEL_SECTION_TEXT_COL_NAME,
      WER_COL_NAME,
      HALLUCINATION_COUNT_COL_NAME,
      GT_TOKS_COL_NAME,
      MODEL_TOKS_COL_NAME,
      HALLUCINATION_PERCENT_COL_NAME,
      HALLUCINATION_COL_NAME,
      TOXIC_COL_NAME,
      TOXIC_PERCENT_COL_NAME,
      DURATION_COL_NAME,
      TRANSCRIPT_DENSITY_COL_NAME,
    ]

    for col_index, title in enumerate(headers, start=1):
      cell = self.worksheet.cell(1, col_index, title)
      cell.font = Font(name="Aptos", size=9, bold=True)
      cell.alignment = Alignment("left", "center")

    self.worksheet.freeze_panes = "A2"
  # === end modification for toxic columns

  # === start modification for duration display format - worksheet_writer.py
  def write_metrics_row(self, metrics: MetricsRow) -> None:
    row_index = self.worksheet.max_row + 1
    font = Font(name="Aptos", size=9)
    alignment = Alignment("left", "center")
    fill_color = CALL_LEVEL_BKGND_COLOR if metrics.is_entire else SAMPLE_LEVEL_BKGND_COLOR
    fill = PatternFill("solid", fgColor=fill_color)

    # Convert duration from milliseconds to minutes for display
    duration_in_minutes = metrics.duration / (60 * 1000) if metrics.duration else 0

    values = [
      metrics.metadata,
      metrics.session_id,
      metrics.section,
      metrics.ground_truth_text,
      metrics.model_text,
      metrics.wer,
      metrics.hallucination_count,
      metrics.ground_truth_tokens,
      metrics.model_tokens,
      metrics.hallucination_percent,
      metrics.hallucination_text,
      metrics.toxic_text,
      metrics.toxic_percent,
      duration_in_minutes,
      metrics.transcript_density,
    ]

    for col_index, value in enumerate(values, start=1):
      cell = self.worksheet.cell(row_index, col_index, value)
      cell.font = font
      cell.alignment = alignment
      cell.fill = fill
      cell.border = THIN_BORDER

      header_value = self.worksheet.cell(1, col_index).value
      if header_value == WER_COL_NAME:
        cell.number_format = "0.0000"
      elif header_value == HALLUCINATION_PERCENT_COL_NAME:
        cell.number_format = "0.0000"
      elif header_value == TOXIC_PERCENT_COL_NAME:
        cell.number_format = "0.0000"
      elif header_value == DURATION_COL_NAME:
        cell.number_format = "0.00"
      elif header_value == TRANSCRIPT_DENSITY_COL_NAME:
        cell.number_format = "0.00"
  # === end modification for duration display format

  def apply_styling(self) -> None:
    from styling import style_metrics_columns
    style_metrics_columns(self.worksheet)

class SummaryWorksheetWriter:
  def __init__(self, workbook: Workbook, worksheet_name: str):
    self.workbook = workbook
    self.worksheet_name = worksheet_name
    self.worksheet: Optional[Worksheet] = None

  def create_worksheet(self, has_speaker_column: bool = False) -> Worksheet:
    if self.worksheet_name in self.workbook.sheetnames:
      del self.workbook[self.worksheet_name]
    self.worksheet = self.workbook.create_sheet(self.worksheet_name)
    self._write_header(has_speaker_column)
    return self.worksheet

  # === start modification for summary toxic% - worksheet_writer.py
  def _write_header(self, has_speaker_column: bool) -> None:
    headers = [METADATA_COL_NAME]
    if has_speaker_column:
      headers.append("Speaker")
    headers.extend([
      AVERAGE_WER_COL_NAME,
      SESSION_COUNT_COL_NAME,
      AVG_HALLUCINATION_PERCENT_COL_NAME,
      AVERAGE_TRX_DENSITY_COL_NAME,
      AVG_TOXIC_PERCENT_COL_NAME
    ])

    for col, title in enumerate(headers, start=1):
      cell = self.worksheet.cell(1, col, title)
      cell.font = Font(name="Aptos", size=9, bold=True)
      cell.alignment = Alignment("left", "center")
  # === end modification for summary toxic%

  #=== start modification for summary toxic% - worksheet_writer.py
  def write_summary_row(self, summary: SummaryData, row_num: int, has_speaker_column: bool) -> None:
      values = [summary.metadata]
      if has_speaker_column:
          values.append(summary.speaker)
      values.extend([
          summary.average_wer,
          summary.session_count,
          summary.average_hallucination_percent,
          summary.average_transcript_density,
          summary.toxic_percent
      ])

      for col, value in enumerate(values, start=1):
          cell = self.worksheet.cell(row_num, col, value)
          cell.font = Font(name="Aptos", size=9)
          cell.alignment = Alignment("left", "center")
          cell.fill = PatternFill(
              "solid",
              fgColor=CALL_LEVEL_BKGND_COLOR if CALL_LEVEL_GRANULARITY else SAMPLE_LEVEL_BKGND_COLOR
          )
          cell.border = THIN_BORDER

          wer_col = 3 if has_speaker_column else 2
          halluc_col = 5 if has_speaker_column else 4
          density_col = 6 if has_speaker_column else 5
          toxic_col = 7 if has_speaker_column else 6

          if col == wer_col or col == halluc_col:
              cell.number_format = "0.0000"
          elif col == density_col:
              cell.number_format = "0.00"
          elif col == toxic_col:
              cell.number_format = "0.0000"
  #=== end modification for summary toxic%

  # === start modification for overall toxic% in G4 - worksheet_writer.py
  def write_overall_toxic_percent(self, metrics_worksheet: Worksheet, has_speaker_column: bool) -> None:
    """
    Write overall toxic percentage to cell G4 (or F4 if no speaker column).
    Calculation: 100 * (total toxic tokens) / (total model tokens) for Customer + Agent
    """
    from openpyxl.styles import PatternFill
    from constants import (
      SECTION_COL_NAME,
      MODEL_TOKS_COL_NAME,
      TOXIC_COL_NAME,
      CUSTOMER_VALUE,
      AGENT_VALUE
    )

    # Find column indices in metrics worksheet
    header_map = {c.value: idx for idx, c in enumerate(metrics_worksheet[1], start=1)}
    section_index = header_map.get(SECTION_COL_NAME, 0) - 1
    model_toks_index = header_map.get(MODEL_TOKS_COL_NAME, 0) - 1
    toxic_index = header_map.get(TOXIC_COL_NAME, 0) - 1

    if section_index < 0 or model_toks_index < 0 or toxic_index < 0:
      return  # Required columns not found

    total_model_tokens = 0
    total_toxic_count = 0

    # Iterate through metrics worksheet rows
    for row in metrics_worksheet.iter_rows(min_row=2, values_only=True):
      if len(row) <= max(section_index, model_toks_index, toxic_index):
        continue

      section_value = row[section_index]

      # Only process "Customer" and "Agent" rows (exclude "Customer1", "Agent2", etc.)
      if section_value in (CUSTOMER_VALUE, AGENT_VALUE):
        model_toks = row[model_toks_index]
        toxic_text = row[toxic_index]

        # Add model tokens
        if isinstance(model_toks, (int, float)):
          total_model_tokens += model_toks

        # Count toxic tokens from comma-separated list
        if toxic_text and isinstance(toxic_text, str):
          toxic_tokens = [t.strip() for t in toxic_text.split(',') if t.strip()]
          total_toxic_count += len(toxic_tokens)

    # Calculate overall toxic percentage
    overall_toxic_percent = (100 * total_toxic_count / total_model_tokens) if total_model_tokens > 0 else 0.0

    # Determine the column for toxic% (G if has_speaker, F if not)
    toxic_col_letter = 'G' if has_speaker_column else 'F'
    cell_address = f'{toxic_col_letter}4'

    # Write to cell G4 (or F4)
    cell = self.worksheet[cell_address]
    cell.value = overall_toxic_percent
    cell.font = Font(name="Aptos", size=9, bold=True)
    cell.alignment = Alignment("left", "center")
    cell.fill = PatternFill("solid", fgColor="A5E06C")  # Light green background
    cell.number_format = "0.000"  # 3 decimal places
    cell.border = THIN_BORDER
  # === end modification for overall toxic% in G4
  
#===============================================================================================================

# monthly_workbook_processor.py

from __future__ import annotations
import os
import re
from datetime import datetime
from openpyxl import load_workbook, Workbook
from openpyxl.styles import Font, Alignment
from openpyxl.utils import get_column_letter
from worksheet_reader import WorksheetReader
from summary_calculator import SummaryCalculator
from worksheet_writer import SummaryWorksheetWriter
from constants import (
  WORKSHEET_PREFIX,
  METRICS_WORKSHEET_NAME,
  AGENT_CUSTOMER_METRICS_WORKSHEET_NAME,
  INPUT_DATA_WORKSHEET_NAME,
  MONTHLY_SUMMARY_WORKSHEET_NAME,
  METRICS_HEADER_COL_WIDTHS,
)

class MonthlyWorkbookProcessor:
  def __init__(self):
    self.summary_calculator = SummaryCalculator()

  def create_monthly_workbook(
      self,
      root_dir: str,
      metrics_paths: list[str],
      prefix: str
  ) -> tuple[str, Workbook]:
    monthly_path = self._get_monthly_output_path(root_dir, metrics_paths, prefix)

    if os.path.exists(monthly_path):
      os.remove(monthly_path)

    has_vtype = self._check_vtype_presence(metrics_paths)

    monthly_workbook = Workbook()
    del monthly_workbook[monthly_workbook.sheetnames[0]]

    self._add_consolidated_input_data(monthly_workbook, metrics_paths)
    self._add_consolidated_metrics(monthly_workbook, metrics_paths, has_vtype)
    self._add_monthly_summary(monthly_workbook, has_vtype)

    monthly_workbook.save(monthly_path)
    return monthly_path, monthly_workbook

  def _get_monthly_output_path(self, root_dir: str, metrics_paths: list[str], prefix: str) -> str:
    dates = []

    for metrics_path in metrics_paths:
      if '_week_of_' in metrics_path:
        _, start, end, year = self._parse_weekly_format(metrics_path)
        dates.append((start, end, year))
      else:
        base = os.path.basename(metrics_path).rsplit(".", 1)[0]
        parts = base.split("_")
        rng, year = parts[1], parts[2]
        start, end = re.split(r"thru|-", rng, maxsplit=1)
        dates.append((start, end, year))

    earliest = min(d[0] for d in dates)
    latest = max(d[1] for d in dates)
    year = dates[0][2]
    filename = f"{prefix}_{earliest}thru{latest}_{year}_monthly_metrics.xlsx"
    return os.path.join(root_dir, filename)

  def _parse_weekly_format(self, path: str) -> tuple[str, str, str, str]:
    earliest = path[-17:-13]
    latest = path[-17:-13]
    year = str(datetime.now().year)
    return path, earliest, latest, year

  def _check_vtype_presence(self, metrics_paths: list[str]) -> bool:
    for path in metrics_paths:
      try:
        workbook = load_workbook(path, read_only=True, data_only=True, keep_links=False)
        try:
          worksheet_name = next((n for n in workbook.sheetnames if n.startswith(WORKSHEET_PREFIX)), None)
          if worksheet_name:
            worksheet = workbook[worksheet_name]
            reader = WorksheetReader(worksheet)
            if reader.has_vtype_column():
              return True
        finally:
          workbook.close()
      except Exception:
        continue
    return False

  def _add_consolidated_input_data(self, monthly_workbook: Workbook, metrics_paths: list[str]) -> None:
    from business_inputs_to_monthly import add_input_data_worksheet_with_metadata
    add_input_data_worksheet_with_metadata(monthly_workbook, metrics_paths)

    from speaker_metrics_styling import style_input_data_worksheet
    input_data_ws = monthly_workbook[monthly_workbook.sheetnames[0]]
    style_input_data_worksheet(input_data_ws)

  def _add_consolidated_metrics(
      self,
      monthly_workbook: Workbook,
      metrics_paths: list[str],
      has_vtype: bool
  ) -> None:
    sheet_name = AGENT_CUSTOMER_METRICS_WORKSHEET_NAME if has_vtype else METRICS_WORKSHEET_NAME
    monthly_metrics_ws = monthly_workbook.create_sheet(sheet_name)

    first = True
    for metrics_path in metrics_paths:
      metrics_wb = load_workbook(metrics_path)
      metrics_ws = metrics_wb[METRICS_WORKSHEET_NAME]

      for i, row_values in enumerate(metrics_ws.iter_rows(values_only=True), start=1):
        if i == 1 and not first:
          continue
        monthly_metrics_ws.append(row_values)
      first = False

    from speaker_metrics_styling import apply_agent_customer_metrics_styling
    apply_agent_customer_metrics_styling(monthly_metrics_ws)

  # === start modification for overall toxic% in G4 - monthly_workbook_processor.py
  def _add_monthly_summary(self, monthly_workbook: Workbook, has_vtype: bool) -> None:
    metrics_ws = monthly_workbook[
      AGENT_CUSTOMER_METRICS_WORKSHEET_NAME if has_vtype else METRICS_WORKSHEET_NAME
    ]

    summaries = self.summary_calculator.calculate_overall_summary(metrics_ws)

    writer = SummaryWorksheetWriter(monthly_workbook, MONTHLY_SUMMARY_WORKSHEET_NAME)
    writer.create_worksheet(has_speaker_column=has_vtype)

    for row_num, summary in enumerate(summaries, start=2):
      writer.write_summary_row(summary, row_num, has_speaker_column=has_vtype)

    # Write overall toxic percentage to cell G4 (or F4)
    writer.write_overall_toxic_percent(metrics_ws, has_speaker_column=has_vtype)

    from speaker_metrics_styling import style_monthly_summary_worksheet

    style_monthly_summary_worksheet(writer.worksheet, has_vtype)
  # === end modification for overall toxic% in G4
  
# ============================================================================================================================

# overall_summary.py

from __future__ import annotations
from openpyxl.worksheet.worksheet import Worksheet
from summary_calculator import SummaryCalculator
from worksheet_writer import SummaryWorksheetWriter
from constants import MONTHLY_SUMMARY_WORKSHEET_NAME, SUMMARY_COL_WIDTHS

#=== start modification for overall toxic% in G4 - overall_summary.py
def add_overall_summary_sheet(workbook, metrics_worksheet: Worksheet) -> None:
  """Compatibility wrapper for existing code that uses functional approach"""
  calculator = SummaryCalculator()
  summaries = calculator.calculate_overall_summary(metrics_worksheet)
  has_speakers = calculator.has_speaker_sections(metrics_worksheet)

  writer = SummaryWorksheetWriter(workbook, MONTHLY_SUMMARY_WORKSHEET_NAME)
  writer.create_worksheet(has_speaker_column=has_speakers)

  for row_num, summary in enumerate(summaries, start=2):
    writer.write_summary_row(summary, row_num, has_speaker_column=has_speakers)

  # Write overall toxic percentage to cell G4 (or F4)
  writer.write_overall_toxic_percent(metrics_worksheet, has_speaker_column=has_speakers)

  for col_letter, width in SUMMARY_COL_WIDTHS.items():
    writer.worksheet.column_dimensions[col_letter].width = width
#=== end modification for overall toxic% in G4