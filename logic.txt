import os
import yaml
from pathlib import Path

class Config:
  def __init__(self, config_path: str):
    with open(config_path, 'r') as f:
      self.config = yaml.safe_load(f)

  @property
  def input_directory(self) -> str:
    return self.config['input_directory']

  @property
  def output_directory(self) -> str:
    return self.config['output_directory']

  @property
  def combined_filepath(self) -> str:
    return self.config['combined_filepath']

  @property
  def action(self) -> str:
    return self.config.get('action', 'combine')

class FileCombiner:
  DELIMITER = "===FILE_START==="
  DELIMITER_END = "===FILE_END==="

  def __init__(self, input_dir: str, combined_file: str):
    self.input_dir = Path(input_dir)
    self.combined_file = Path(combined_file)

  def combine(self):
    os.makedirs(self.combined_file.parent, exist_ok=True)

    with open(self.combined_file, 'w', encoding='utf-8') as outfile:
      for file_path in sorted(self.input_dir.iterdir()):
        if file_path.is_file():
          outfile.write(f"{self.DELIMITER}:{file_path.name}\n")
          with open(file_path, 'r', encoding='utf-8') as infile:
            outfile.write(infile.read())
          outfile.write(f"\n{self.DELIMITER_END}:{file_path.name}\n")

class FileSplitter:
  DELIMITER = "===FILE_START==="
  DELIMITER_END = "===FILE_END==="

  def __init__(self, combined_file: str, output_dir: str):
    self.combined_file = Path(combined_file)
    self.output_dir = Path(output_dir)

  def split(self):
    os.makedirs(self.output_dir, exist_ok=True)

    with open(self.combined_file, 'r', encoding='utf-8') as infile:
      current_file = None
      current_content = []

      for line in infile:
        if line.startswith(self.DELIMITER):
          if current_file:
            self._write_file(current_file, current_content)
          current_file = line.split(':', 1)[1].strip()
          current_content = []
        elif line.startswith(self.DELIMITER_END):
          if current_file:
            self._write_file(current_file, current_content)
          current_file = None
          current_content = []
        elif current_file:
          current_content.append(line)

  def _write_file(self, filename: str, content: list):
    output_path = self.output_dir / filename
    with open(output_path, 'w', encoding='utf-8') as f:
      f.writelines(content)

class FileManager:
  def __init__(self, config_path: str = "config.yaml"):
    self.config = Config(config_path)

  def combine_files(self):
    combiner = FileCombiner(
      self.config.input_directory,
      self.config.combined_filepath
    )
    combiner.combine()
    print(f"Combined files written to: {self.config.combined_filepath}")

  def split_files(self):
    splitter = FileSplitter(
      self.config.combined_filepath,
      self.config.output_directory
    )
    splitter.split()
    print(f"Files extracted to: {self.config.output_directory}")

def main():
  manager = FileManager()

  action = manager.config.action

  if action == "combine":
    manager.combine_files()
  elif action == "split":
    manager.split_files()
  else:
    print(f"Invalid action '{action}'. Use 'combine' or 'split'")

if __name__ == "__main__":
  main()
  
# ===================

input_directory: "j:/projects/sheet-logic/more_on_oop"
output_directory: "j:/projects/sheet-logic"
combined_filepath: "j:/projects/sheet-logic/combined.txt"
action: "combine"