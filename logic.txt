class HTMLReportWriter:
  """Writes HTML report with color-coded transcripts"""

  def __init__(self, df: pd.DataFrame, output_path: str):
    self.df = df
    self.output_path = output_path

  def get_word_alignments(self, reference: str, hypothesis: str):
    """Get word-level alignment with S/D/I tags using nltk_jiwer_utils"""
    from nltk_jiwer_utils import get_jiwer_result, get_jiwer_alignment

    if not reference and not hypothesis:
      return [], []

    # Get jiwer result and alignment
    jiwer_result = get_jiwer_result(reference, hypothesis)
    alignment = get_jiwer_alignment(jiwer_result)

    # Parse the alignment strings
    ref_tagged = []
    hyp_tagged = []

    for line in alignment:
      # Parse format: "OPERATION | ref_word | hyp_word"
      parts = [p.strip() for p in line.split("|")]
      if len(parts) != 3:
        continue

      operation = parts[0].upper()
      ref_word = parts[1]
      hyp_word = parts[2]

      if operation == "CORRECT":
        ref_tagged.append(('correct', ref_word))
        hyp_tagged.append(('correct', hyp_word))
      elif operation == "SUBSTITUTION":
        ref_tagged.append(('substitute', ref_word))
        hyp_tagged.append(('substitute', hyp_word))
      elif operation == "DELETION":
        ref_tagged.append(('delete', ref_word))
        hyp_tagged.append(('delete', '***'))
      elif operation == "INSERTION":
        ref_tagged.append(('insert', '***'))
        hyp_tagged.append(('insert', hyp_word))

    return ref_tagged, hyp_tagged

  def format_transcript(self, tagged_words):
    """Format transcript with color-coded words"""
    html_parts = []

    for tag, word in tagged_words:
      if word == '***':
        # Use lighter styling for placeholder markers
        html_parts.append(f'<span style="color: #999; font-style: italic;">{word}</span>')
      elif tag == 'correct':
        # Gray text for correct words
        html_parts.append(f'<span style="color: #808080;">{word}</span>')
      elif tag == 'substitute':
        # Black text with orange background for substitutions
        html_parts.append(
          f'<span style="color: #000; background-color: #FF8C00; padding: 2px 4px; border-radius: 3px;">{word}</span>')
      elif tag == 'delete':
        # White text with red background for deletions
        html_parts.append(
          f'<span style="color: #fff; background-color: #DC143C; padding: 2px 4px; border-radius: 3px;">{word}</span>')
      elif tag == 'insert':
        # White text with blue background for insertions
        html_parts.append(
          f'<span style="color: #fff; background-color: #1E90FF; padding: 2px 4px; border-radius: 3px;">{word}</span>')
      else:
        html_parts.append(f'<span>{word}</span>')

    return ' '.join(html_parts)

  def write(self):
    """Write HTML report"""
    html = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcript Comparison - Triton vs Vllm</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 10px;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .header {
            position: sticky;
            top: 0;
            background-color: #f5f5f5;
            z-index: 100;
            padding: 20px 20px 10px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .content {
            padding: 0 20px 20px 20px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin: 0 0 10px 0;
        }
        .legend {
            text-align: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .legend span {
            margin: 0 15px;
            font-size: 14px;
        }
        .legend .sample-correct {
            color: #808080;
        }
        .legend .sample-substitute {
            color: #000;
            background-color: #FF8C00;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .legend .sample-delete {
            color: #fff;
            background-color: #DC143C;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .legend .sample-insert {
            color: #fff;
            background-color: #1E90FF;
            padding: 2px 6px;
            border-radius: 3px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th {
            background-color: #4CAF50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border: 1px dotted #ddd;
            position: sticky;
            top: 120px;
            z-index: 10;
        }
        tr, td {
          line-height: 0.5;
          vertical-align: middle;
        }
        td {
            padding: 2px;
            border: 1px dotted #ddd;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f0f0f0;
        }
        .index-col {
            width: 10px;
            text-align: center;
            font-weight: 600;
            color: #666;
        }
        .session-col {
            width: 80px;
            font-weight: 600;
            color: #333;
            text-align: center;
        }
        .speaker-col {
            width: 40px;
            font-weight: 600;
            color: #333;
        }
        .seqrange-col {
            width: 60px;
            text-align: center;
            font-size: 9px;
        }
        .seqrange-mismatch {
            background-color: #FFFF99;
        }
        .transcript-col {
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>&xlarr; Triton (Reference GT) vs vLLM &xrarr;</h1>

        <div class="legend">
            <!--span class="sample-correct">Correct</span-->
            <span class="sample-substitute">Substitution</span>
            <span class="sample-delete">Deletion</span>
            <span class="sample-insert">Insertion</span>
        </div>
    </div>

    <div class="content">
        <table>
            <thead>
                <tr>
                    <th class="index-col">Index</th>
                    <th class="session-col">Session ID</th>
                    <th class="speaker-col">Speaker</th>
                    <th class="transcript-col">Triton Transcript (Reference GT)</th>
                    <th class="seqrange-col">SeqRT</th>
                    <th class="seqrange-col">SeqRV</th>
                    <th class="transcript-col">vLLM Transcript (Relative to Triton)</th>
                </tr>
            </thead>
            <tbody>
"""

    # Add data rows
    for _, row in self.df.iterrows():
      index = row['index']
      session_id = row['session_id']
      speaker = row['Triton_Speaker'] or row['Vllm_Speaker'] or 'Unknown'
      triton_text = row['Triton_Transcript'] or ''
      vllm_text = row['Vllm_Transcript'] or ''

      # Get SeqNumRange values
      triton_seqrange = str(row['Triton_SeqNumRange']) if pd.notna(row['Triton_SeqNumRange']) else ''
      vllm_seqrange = str(row['Vllm_SeqNumRange']) if pd.notna(row['Vllm_SeqNumRange']) else ''

      # Check if SeqNumRanges are different
      seqrange_mismatch = triton_seqrange != vllm_seqrange
      seqrange_class = 'seqrange-col seqrange-mismatch' if seqrange_mismatch else 'seqrange-col'

      # Get word alignments
      ref_tagged, hyp_tagged = self.get_word_alignments(triton_text, vllm_text)

      # Format transcripts with colors
      triton_formatted = self.format_transcript(ref_tagged) if ref_tagged else triton_text
      vllm_formatted = self.format_transcript(hyp_tagged) if hyp_tagged else vllm_text

      html += f"""            <tr>
                <td class="index-col">{index}</td>
                <td class="session-col">{session_id}</td>
                <td class="speaker-col">{speaker}</td>
                <td class="transcript-col">{triton_formatted}</td>
                <td class="{seqrange_class}">{triton_seqrange}</td>
                <td class="{seqrange_class}">{vllm_seqrange}</td>
                <td class="transcript-col">{vllm_formatted}</td>
            </tr>
"""

    html += """        </tbody>
    </table>
    </div>
</body>
</html>"""

    # Write to file
    with open(self.output_path, 'w', encoding='utf-8') as f:
      f.write(html)