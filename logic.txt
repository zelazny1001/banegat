# vg_parallel_launcher.py
import sys, subprocess, time, os

SCRIPT_ROOT = "/projects/root/"
SCRIPT = os.path.join(SCRIPT_ROOT, "local_voice_gateway_simulator_2.py")
NUM_INSTANCES = 10
INSTANCES_PER_SECOND = 100
CREATE_NO_WINDOW = 0x08000000

interval = 1.0 / INSTANCES_PER_SECOND

start_time = time.time()

procs = {}

for i in range(1, NUM_INSTANCES + 1):
    target = start_time + (i - 1) * interval
    sleep = target - time.time()
    if sleep > 0:
        time.sleep(sleep)
    p = subprocess.Popen([sys.executable, SCRIPT], cwd=SCRIPT_ROOT)
    elapsed = time.time() - start_time
    print(f"[{i}/{NUM_INSTANCES}] Launched PID={p.pid} at {elapsed:.2f}s")
    procs[i] = p

remaining = set(procs)
completed = 0

while remaining:
    for i in list(remaining):
        p = procs[i]
        if p.poll() is not None:
            completed += 1
            elapsed = time.time() - start_time
            print(f"[{completed}/{NUM_INSTANCES}] Elapsed: {elapsed:.2f}s")
            remaining.remove(i)
    time.sleep(0.2)

print("All instances completed.")