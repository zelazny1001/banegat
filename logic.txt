#=== start modification for timestamp - constants.py
TIMESTAMP_COL_NAME: str = "Timestamp"
DURATION_COL_NAME: str = "duration"
TRANSCRIPT_DENSITY_COL_NAME: str = "Toks/Sec."
AVERAGE_TRX_DENSITY_COL_NAME: str = "Avg. Toks/Sec."
#=== end modification for timestamp

#=== start modification for timestamp - constants.py
METRICS_HEADER_COL_WIDTHS = {"A": 27, "B": 65, "C": 9, "D": 63, "E": 63, "F": 8, "G": 12, "H": 10, "I": 15, "J": 12, "K": 12}
SUMMARY_COL_WIDTHS = {"A": 30, "B": 13, "C": 16, "D": 22, "E": 15}
#=== end modification for timestamp

#=== start modification for timestamp - data_models.py
@dataclass
class TranscriptPair:
    transcript: str
    ground_truth: str
    timestamp: Optional[int] = None
    duration: int = 0
#=== end modification for timestamp

#=== start modification for timestamp - data_models.py
@dataclass
class MetricsRow:
    metadata: str
    session_id: str
    section: str
    ground_truth_text: str
    model_text: str
    wer: float
    hallucination_count: int
    ground_truth_tokens: int
    hallucination_percent: Optional[float]
    hallucination_text: str
    is_entire: bool = False
    duration: int = 0
    transcript_density: Optional[float] = None
#=== end modification for timestamp

#=== start modification for timestamp - data_models.py
@dataclass
class SummaryData:
    metadata: str
    average_wer: float
    session_count: int
    average_hallucination_percent: float
    speaker: Optional[str] = None
    average_transcript_density: Optional[float] = None
#=== end modification for timestamp

  # === start modification for timestamp - metrics_calculator.py
  def calculate_metrics_for_section(
      self,
      metadata: str,
      session_id: str,
      section_label: str,
      pairs: list[TranscriptPair],
      hallucination_counts: list[int],
      hallucination_texts: list[str],
      is_entire: bool = False
  ) -> MetricsRow:
    if not pairs:
      return MetricsRow(
        metadata=metadata,
        session_id=session_id,
        section=section_label,
        ground_truth_text="",
        model_text="",
        wer=float("nan"),
        hallucination_count=0,
        ground_truth_tokens=0,
        hallucination_percent=None,
        hallucination_text="",
        is_entire=is_entire,
        duration=0,
        transcript_density=None
      )

    gt_text, model_text, wer, gt_tokens = self.wer_calculator.calculate_for_pairs(pairs)
    hallucination_total = sum(hallucination_counts)
    hallucination_percent = (100 * hallucination_total / gt_tokens) if gt_tokens else None
    hallucination_text = " ".join(hallucination_texts)

    total_duration = sum(p.duration for p in pairs)
    model_tokens = len(model_text.split()) if model_text else 0
    transcript_density = (1000 * model_tokens) /total_duration if total_duration > 0 else None

    return MetricsRow(
      metadata=metadata,
      session_id=session_id,
      section=section_label,
      ground_truth_text=gt_text,
      model_text=model_text,
      wer=wer,
      hallucination_count=hallucination_total,
      ground_truth_tokens=gt_tokens,
      hallucination_percent=hallucination_percent,
      hallucination_text=hallucination_text,
      is_entire=is_entire,
      duration=total_duration,
      transcript_density=transcript_density
    )
  # === end modification for timestamp
  
#=== start modification for timestamp - styling.py
def style_metrics_columns(worksheet: Worksheet) -> None:
    for col_index, width in {1: 27, 2: 65, 3: 9, 4: 63, 5: 63, 6: 9, 7: 12, 8: 10, 9: 15, 10: 12, 11: 12}.items():
        worksheet.column_dimensions[get_column_letter(col_index)].width = width
    worksheet.auto_filter.ref = f"A1:K{worksheet.max_row}"
#=== end modification for timestamp

  # === start modification for timestamp - summary_calculator.py
  def calculate_overall_summary(self, metrics_worksheet: Worksheet) -> list[SummaryData]:
    self.metrics_worksheet = metrics_worksheet
    header_map = {c.value: idx for idx, c in enumerate(metrics_worksheet[1], start=1)}
    rows = list(metrics_worksheet.iter_rows(min_row=2, values_only=True))

    wer_index = header_map[WER_COL_NAME] - 1
    hallucination_percent_index = header_map[HALLUCINATION_PERCENT_COL_NAME] - 1
    section_index = header_map[SECTION_COL_NAME] - 1
    metadata_index = header_map[METADATA_COL_NAME] - 1

    has_speakers = self.has_speaker_sections(metrics_worksheet)

    if has_speakers:
      return self._calculate_speaker_summary(
        rows, wer_index, hallucination_percent_index, section_index, metadata_index
      )
    else:
      return self._calculate_non_speaker_summary(
        rows, wer_index, hallucination_percent_index, section_index, metadata_index
      )
  # === end modification for timestamp

  # === start modification for timestamp - summary_calculator.py
  def _calculate_speaker_summary(
      self,
      rows: list,
      wer_index: int,
      hallucination_percent_index: int,
      section_index: int,
      metadata_index: int
  ) -> list[SummaryData]:
    summaries: list[SummaryData] = []

    density_index = None
    for idx, cell in enumerate(self.metrics_worksheet[1]):
      if cell.value == TRANSCRIPT_DENSITY_COL_NAME:
        density_index = idx
        break

    for speaker in [CUSTOMER_VALUE, AGENT_VALUE]:
      if CALL_LEVEL_GRANULARITY:
        wer_values = [
          row[wer_index] for row in rows
          if row[section_index] == speaker and isinstance(row[wer_index], (int, float))
        ]
        hallucination_values = [
          row[hallucination_percent_index] for row in rows
          if row[section_index] == speaker and isinstance(row[hallucination_percent_index], (int, float))
        ]
        density_values = [
          row[density_index] for row in rows
          if density_index is not None and row[section_index] == speaker
             and isinstance(row[density_index], (int, float))
        ] if density_index is not None else []
      else:
        wer_values = [
          row[wer_index] for row in rows
          if isinstance(row[section_index], str) and row[section_index].startswith(speaker)
             and row[section_index] != speaker and isinstance(row[wer_index], (int, float))
        ]
        hallucination_values = [
          row[hallucination_percent_index] for row in rows
          if isinstance(row[section_index], str) and row[section_index].startswith(speaker)
             and row[section_index] != speaker and isinstance(row[hallucination_percent_index], (int, float))
        ]
        density_values = [
          row[density_index] for row in rows
          if density_index is not None
             and isinstance(row[section_index], str)
             and row[section_index].startswith(speaker)
             and row[section_index] != speaker
             and isinstance(row[density_index], (int, float))
        ] if density_index is not None else []

      average_wer = sum(wer_values) / len(wer_values) if wer_values else 0.0
      average_hallucination = sum(hallucination_values) / len(hallucination_values) if hallucination_values else 0.0
      average_density = sum(density_values) / len(density_values) if density_values else None
      session_count = sum(1 for row in rows if row[section_index] == speaker)
      normalized_meta = self.normalizer.normalize(rows, metadata_index, SPREADSHEET_PREFIX)

      summaries.append(SummaryData(
        metadata=normalized_meta,
        average_wer=average_wer,
        session_count=session_count,
        average_hallucination_percent=average_hallucination,
        speaker=speaker,
        average_transcript_density=average_density
      ))

    return summaries
  # === end modification for timestamp
  
  #=== start modification for timestamp - summary_calculator.py
  def _calculate_non_speaker_summary(
      self,
      rows: list,
      wer_index: int,
      hallucination_percent_index: int,
      section_index: int,
      metadata_index: int
  ) -> list[SummaryData]:
      density_index = None
      for idx, cell in enumerate(self.metrics_worksheet[1]):
          if cell.value == TRANSCRIPT_DENSITY_COL_NAME:
              density_index = idx
              break

      if CALL_LEVEL_GRANULARITY:
          wer_values = [
              row[wer_index] for row in rows
              if row[section_index] == ENTIRE_COL_NAME and isinstance(row[wer_index], (int, float))
          ]
          hallucination_values = [
              row[hallucination_percent_index] for row in rows
              if row[section_index] == ENTIRE_COL_NAME and isinstance(row[hallucination_percent_index], (int, float))
          ]
          density_values = [
              row[density_index] for row in rows
              if density_index is not None and row[section_index] == ENTIRE_COL_NAME
              and isinstance(row[density_index], (int, float))
          ] if density_index is not None else []
      else:
          wer_values = [
              row[wer_index] for row in rows
              if row[section_index] != ENTIRE_COL_NAME and isinstance(row[wer_index], (int, float))
          ]
          hallucination_values = [
              row[hallucination_percent_index] for row in rows
              if row[section_index] != ENTIRE_COL_NAME and isinstance(row[hallucination_percent_index], (int, float))
          ]
          density_values = [
              row[density_index] for row in rows
              if density_index is not None and row[section_index] != ENTIRE_COL_NAME
              and isinstance(row[density_index], (int, float))
          ] if density_index is not None else []

      average_wer = sum(wer_values) / len(wer_values) if wer_values else 0.0
      average_hallucination = sum(hallucination_values) / len(hallucination_values) if hallucination_values else 0.0
      average_density = sum(density_values) / len(density_values) if density_values else None
      normalized_meta = self.normalizer.normalize(rows, metadata_index, SPREADSHEET_PREFIX)
      session_count = sum(1 for row in rows if row[section_index] == ENTIRE_COL_NAME)

      return [SummaryData(
          metadata=normalized_meta,
          average_wer=average_wer,
          session_count=session_count,
          average_hallucination_percent=average_hallucination,
          average_transcript_density=average_density
      )]
  #=== end modification for timestamp
  
  # === start modification for timestamp - worksheet_reader.py
  def read_sessions(self) -> dict[str, SessionData]:
    session_id_index = self.header_map[SESSION_ID_COL_NAME] - 1
    raw_transcript_index = self.header_map[RAW_TRANSCRIPT_COL_NAME] - 1
    ground_truth_index = self.header_map[GROUND_TRUTH_COL_NAME] - 1
    timestamp_index = self.header_map.get(TIMESTAMP_COL_NAME, 0) - 1 if TIMESTAMP_COL_NAME in self.header_map else None

    sessions: dict[str, list[TranscriptPair]] = {}
    prev_session_id = None
    prev_timestamp = None

    for row in self.worksheet.iter_rows(min_row=2, values_only=True):
      session_id = str(row[session_id_index] or "").strip()
      if not session_id:
        continue

      timestamp = None
      duration = 0
      if timestamp_index is not None and timestamp_index >= 0 and len(row) > timestamp_index:
        timestamp_value = row[timestamp_index]
        if timestamp_value is not None:
          timestamp = int(timestamp_value)
          if prev_session_id == session_id and prev_timestamp is not None:
            duration = timestamp - prev_timestamp

      pair = TranscriptPair(
        transcript=row[raw_transcript_index],
        ground_truth=row[ground_truth_index],
        timestamp=timestamp,
        duration=duration
      )
      sessions.setdefault(session_id, []).append(pair)

      prev_session_id = session_id
      prev_timestamp = timestamp

    return {
      sid: SessionData(session_id=sid, transcript_pairs=pairs)
      for sid, pairs in sessions.items()
    }
  # === end modification for timestamp

  # === start modification for timestamp - worksheet_reader.py
  def read_speaker_sessions(self) -> dict[str, SpeakerSessionData]:
    session_id_index = self.header_map[SESSION_ID_COL_NAME] - 1
    raw_transcript_index = self.header_map[RAW_TRANSCRIPT_COL_NAME] - 1
    ground_truth_index = self.header_map[GROUND_TRUTH_COL_NAME] - 1
    vtype_index = self.header_map[VTYPE_COL_NAME] - 1
    timestamp_index = self.header_map.get(TIMESTAMP_COL_NAME, 0) - 1 if TIMESTAMP_COL_NAME in self.header_map else None

    sessions: dict[str, SpeakerSessionData] = {}
    prev_session_id = None
    prev_timestamp = None

    for row in self.worksheet.iter_rows(min_row=2, values_only=True):
      session_id = str(row[session_id_index] or "").strip()
      if not session_id:
        continue

      if session_id not in sessions:
        sessions[session_id] = SpeakerSessionData(session_id=session_id)

      timestamp = None
      duration = 0
      if timestamp_index is not None and timestamp_index >= 0 and len(row) > timestamp_index:
        timestamp_value = row[timestamp_index]
        if timestamp_value is not None:
          timestamp = int(timestamp_value)
          if prev_session_id == session_id and prev_timestamp is not None:
            duration = timestamp - prev_timestamp

      vtype = str(row[vtype_index] or "").strip()
      pair = TranscriptPair(
        transcript=row[raw_transcript_index],
        ground_truth=row[ground_truth_index],
        timestamp=timestamp,
        duration=duration
      )

      if vtype == CUSTOMER_VALUE:
        sessions[session_id].customer_pairs.append(pair)
      elif vtype == AGENT_VALUE:
        sessions[session_id].agent_pairs.append(pair)

      prev_session_id = session_id
      prev_timestamp = timestamp

    return sessions
  # === end modification for timestamp

  # === start modification for timestamp - worksheet_writer.py
  def _write_header(self) -> None:
    headers = [
      METADATA_COL_NAME,
      SESSION_ID_COL_NAME,
      SECTION_COL_NAME,
      GT_SECTION_TEXT_COL_NAME,
      MODEL_SECTION_TEXT_COL_NAME,
      WER_COL_NAME,
      HALLUCINATION_COUNT_COL_NAME,
      GT_TOKS_COL_NAME,
      HALLUCINATION_PERCENT_COL_NAME,
      HALLUCINATION_COL_NAME,
      DURATION_COL_NAME,
      TRANSCRIPT_DENSITY_COL_NAME,
    ]

    for col_index, title in enumerate(headers, start=1):
      cell = self.worksheet.cell(1, col_index, title)
      cell.font = Font(name="Aptos", size=9, bold=True)
      cell.alignment = Alignment("left", "center")

    self.worksheet.freeze_panes = "A2"
  # === end modification for timestamp

  # === start modification for timestamp - worksheet_writer.py
  def write_metrics_row(self, metrics: MetricsRow) -> None:
    row_index = self.worksheet.max_row + 1
    font = Font(name="Aptos", size=9)
    alignment = Alignment("left", "center")
    fill_color = CALL_LEVEL_BKGND_COLOR if metrics.is_entire else SAMPLE_LEVEL_BKGND_COLOR
    fill = PatternFill("solid", fgColor=fill_color)

    values = [
      metrics.metadata,
      metrics.session_id,
      metrics.section,
      metrics.ground_truth_text,
      metrics.model_text,
      metrics.wer,
      metrics.hallucination_count,
      metrics.ground_truth_tokens,
      metrics.hallucination_percent,
      metrics.hallucination_text,
      metrics.duration,
      metrics.transcript_density,
    ]

    for col_index, value in enumerate(values, start=1):
      cell = self.worksheet.cell(row_index, col_index, value)
      cell.font = font
      cell.alignment = alignment
      cell.fill = fill
      cell.border = THIN_BORDER

      header_value = self.worksheet.cell(1, col_index).value
      if header_value == WER_COL_NAME:
        cell.number_format = "0.0000"
      elif header_value == HALLUCINATION_PERCENT_COL_NAME:
        cell.number_format = "0.0000"
      elif header_value == TRANSCRIPT_DENSITY_COL_NAME:
        cell.number_format = "0.00"
  # === end modification for timestamp

  # === start modification for timestamp - worksheet_writer.py
  def _write_header(self, has_speaker_column: bool) -> None:
    headers = [METADATA_COL_NAME]
    if has_speaker_column:
      headers.append("Speaker")
    headers.extend([
      AVERAGE_WER_COL_NAME,
      SESSION_COUNT_COL_NAME,
      AVG_HALLUCINATION_PERCENT_COL_NAME,
      AVERAGE_TRX_DENSITY_COL_NAME
    ])

    for col, title in enumerate(headers, start=1):
      cell = self.worksheet.cell(1, col, title)
      cell.font = Font(name="Aptos", size=9, bold=True)
      cell.alignment = Alignment("left", "center")
  # === end modification for timestamp

  #=== start modification for timestamp - worksheet_writer.py
  def write_summary_row(self, summary: SummaryData, row_num: int, has_speaker_column: bool) -> None:
      values = [summary.metadata]
      if has_speaker_column:
          values.append(summary.speaker)
      values.extend([
          summary.average_wer,
          summary.session_count,
          summary.average_hallucination_percent,
          summary.average_transcript_density
      ])

      for col, value in enumerate(values, start=1):
          cell = self.worksheet.cell(row_num, col, value)
          cell.font = Font(name="Aptos", size=9)
          cell.alignment = Alignment("left", "center")
          cell.fill = PatternFill(
              "solid",
              fgColor=CALL_LEVEL_BKGND_COLOR if CALL_LEVEL_GRANULARITY else SAMPLE_LEVEL_BKGND_COLOR
          )
          cell.border = THIN_BORDER

          wer_col = 3 if has_speaker_column else 2
          halluc_col = 5 if has_speaker_column else 4
          density_col = 6 if has_speaker_column else 5

          if col == wer_col or col == halluc_col:
              cell.number_format = "0.0000"
          elif col == density_col:
              cell.number_format = "0.00"
  #=== end modification for timestamp
  
