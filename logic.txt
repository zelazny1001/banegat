class DataReader:
  def __init__(self, workbook_path: str):
    self.workbook_path = workbook_path

  def find_column_indices(self, worksheet) -> Dict[str, int]:
    headers = [cell.value for cell in worksheet[1]]

    required_columns = ['threshold', 'micro precision', 'TP', 'FN', 'FP', 'TN']
    column_indices = {}

    for col_name in required_columns:
      try:
        column_indices[col_name] = headers.index(col_name)
      except ValueError:
        print(f"ERROR: Required column '{col_name}' not found in worksheet")
        print(f"  Available columns: {headers}")
        sys.exit(1)

    return column_indices

  def read_worksheet(self, worksheet_name: str) -> WorksheetData:
    workbook = openpyxl.load_workbook(self.workbook_path)
    worksheet = workbook[worksheet_name]

    col_indices = self.find_column_indices(worksheet)

    thresholds = []
    precisions = {}
    totals = set()

    for row in worksheet.iter_rows(min_row=2, values_only=True):
      if row[col_indices['threshold']] is None:
        continue

      threshold = row[col_indices['threshold']]
      precision = row[col_indices['micro precision']]
      tp = row[col_indices['TP']]
      fn = row[col_indices['FN']]
      fp = row[col_indices['FP']]
      tn = row[col_indices['TN']]

      total = tp + fn + fp + tn
      totals.add(total)

      thresholds.append(threshold)
      precisions[threshold] = precision

    if len(totals) != 1:
      print(f"ERROR: TP+FN+FP+TN not constant in worksheet '{worksheet_name}'")
      print(f"  Found totals: {totals}")
      sys.exit(1)

    workbook.close()
    return WorksheetData(thresholds, precisions, totals.pop())

  def read(self, worksheet1_name: str, worksheet2_name: str) -> Tuple[WorksheetData, WorksheetData]:
    data1 = self.read_worksheet(worksheet1_name)
    data2 = self.read_worksheet(worksheet2_name)

    set1 = set(data1.thresholds)
    set2 = set(data2.thresholds)

    if set1 != set2:
      print(f"ERROR: Threshold mismatch between worksheets")
      print(f"  Only in '{worksheet1_name}': {set1 - set2}")
      print(f"  Only in '{worksheet2_name}': {set2 - set1}")
      sys.exit(1)

    return data1, data2