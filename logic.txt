# asr_metrics_calc.py
# ingest all ASR_*.xlsx spreadsheets in ROOT_DIR and write per-file metrics & a consolidated monthly report

from __future__ import annotations
import os
import re
import requests
import random

from openpyxl import load_workbook, Workbook
from openpyxl.worksheet.worksheet import Worksheet
from openpyxl.styles import Font, Alignment, PatternFill
from openpyxl.utils import get_column_letter
from openpyxl.styles import Border, Side

thin_side   = Side(border_style="thin", color="D3D3D3")
thin_border = Border(top=thin_side, bottom=thin_side, left=thin_side, right=thin_side)

CODE_IS_BEING_TESTED: bool = True

# processing parameters
ROOT_DIR: str = "j:/projects/sheet-logic/asr-april-2025"
SPREADSHEET_PREFIX: str = "ASR"
WORKSHEET_PREFIX: str = "ASR"  # input worksheet name startswith this

DO_MONTHLY_CONSOLIDATION = True  # also build monthly consolidated metrics

# input worksheet columns
SESSION_ID_COL_NAME: str         = "session_id"
RAW_TRANSCRIPT_COL_NAME: str     = "raw_transcript"
GROUND_TRUTH_COL_NAME: str       = "Ground Truth Transcript"
HALLUCINATION_COL_NAME: str      = "Hallucination"

# metrics worksheet
METRICS_WORKSHEET_NAME: str      = "metrics"
METADATA_COL_NAME: str           = "metadata"
ENTIRE_COL_NAME: str             = "entire"
GT_SECTION_TEXT_COL_NAME: str    = "gt section"
MODEL_SECTION_TEXT_COL_NAME: str = "model text"

# metrics computation
NUMBER_OF_SECTIONS: int          = 5
WER_POST_ENDPOINT: str           = "https://wer_host:3281/word_error_rate"

# summary worksheet
SUMMARY_WORKSHEET_NAME: str               = "summary"
AVERAGE_WER_COL_NAME: str                 = "AVG_WER"
SESSION_COUNT_COL_NAME: str               = "num sessions"
HALLUCINATION_COUNT_COL_NAME: str         = "Hallucination Count"
HALLUCINATION_AVG_COL_NAME:   str         = "Hallucination Avg"


def list_input_spreadsheets(root_dir: str) -> list[str]:
    return sorted(
        os.path.join(root_dir, f)
        for f in os.listdir(root_dir)
        if (
            f.startswith(f"{SPREADSHEET_PREFIX}_")
            and f.lower().endswith(".xlsx")
            and not f.endswith("_metrics.xlsx")
            and not f.endswith("_monthly_metrics.xlsx")
        )
    )



def get_name_of_results_spreadsheet(input_path: str) -> str:
    dir_name = os.path.dirname(input_path)
    base = os.path.basename(input_path).rsplit(".", 1)[0]
    return os.path.join(dir_name, f"{base}_metrics.xlsx")


def preprocess(text: str) -> str:
    if not text:
        return ""
    s = str(text).lower()
    s = re.sub(r"[.,\-?â€¦]", " ", s)
    s = re.sub(r"\{[^}]*\}", "", s)
    s = re.sub(r"[\[\]]", "", s)
    return re.sub(r"\s+", " ", s).strip()


def get_wer_from_api(endpoint: str, ground_truth: str, transcript: str) -> float:
    if CODE_IS_BEING_TESTED:
        return random.random() * 50
    try:
        resp = requests.post(
            endpoint,
            json={"groundTruth": ground_truth, "transcript": transcript},
            verify=False,
            timeout=10
        )
        return float(resp.text.strip())
    except Exception:
        return float('nan')


def add_metrics_sheet(wb: Workbook) -> Worksheet:
    if METRICS_WORKSHEET_NAME in wb.sheetnames:
        del wb[METRICS_WORKSHEET_NAME]
    return wb.create_sheet(METRICS_WORKSHEET_NAME)


def write_header(ws: Worksheet) -> None:
    headers = [
        METADATA_COL_NAME,
        SESSION_ID_COL_NAME,
        "section",
        GT_SECTION_TEXT_COL_NAME,
        MODEL_SECTION_TEXT_COL_NAME,
        "WER"
    ]
    for idx, title in enumerate(headers, start=1):
        cell = ws.cell(row=1, column=idx, value=title)
        cell.font = Font(name="Aptos", size=9, bold=True)
        cell.alignment = Alignment("left", "center")
    ws.freeze_panes = "A2"


def write_metrics_row(
    ws: Worksheet,
    metadata: str,
    session_id: str,
    section,
    gt_text: str,
    model_text: str,
    wer: float,
    is_entire: bool = False
) -> None:
    row = ws.max_row + 1
    body_font  = Font(name="Aptos", size=9)
    body_align = Alignment("left", "center")
    fill = PatternFill("solid", fgColor="00FFFF") if is_entire else None

    vals = (metadata, session_id, section, gt_text, model_text, wer)
    for col_idx, v in enumerate(vals, start=1):
        cell = ws.cell(row=row, column=col_idx, value=v)
        cell.font = body_font
        cell.alignment = body_align
        if fill:
            cell.fill = fill
            cell.border = thin_border
        if col_idx == 6:
            cell.number_format = "0.00"


def process_sessions(input_ws: Worksheet, metrics_ws: Worksheet, metadata: str) -> None:
    data = list(input_ws.iter_rows(min_row=2, values_only=True))
    sessions: dict[str, list[tuple[str, str]]] = {}
    for sid, raw, gt, *rest in data:
        sessions.setdefault(sid, []).append((raw, gt))

    for sid, entries in sessions.items():
        # entire session
        gt_all  = " ".join(preprocess(gt) for _, gt in entries)
        raw_all = " ".join(preprocess(raw) for raw, _ in entries)
        wer_ent = get_wer_from_api(WER_POST_ENDPOINT, gt_all, raw_all)
        write_metrics_row(metrics_ws, metadata, sid, ENTIRE_COL_NAME, gt_all, raw_all, wer_ent, True)

        # sections
        total = len(entries)
        base  = total // NUMBER_OF_SECTIONS
        rem   = total % NUMBER_OF_SECTIONS
        start = 0
        for sec in range(1, NUMBER_OF_SECTIONS + 1):
            cnt = base + (1 if sec <= rem else 0)
            if cnt == 0:
                break
            block = entries[start:start+cnt]
            start += cnt
            gt_blk = " ".join(gt for _, gt in block)
            raw_blk= " ".join(raw for raw, _ in block)
            wer_s = get_wer_from_api(WER_POST_ENDPOINT, preprocess(gt_blk), preprocess(raw_blk))
            write_metrics_row(metrics_ws, metadata, sid, sec, gt_blk, raw_blk, wer_s)


def style_columns(ws: Worksheet) -> None:
    widths = {1:27, 2:65, 3:9, 4:63, 5:63, 6:9}
    for col, w in widths.items():
        ws.column_dimensions[get_column_letter(col)].width = w
    ws.auto_filter.ref = f"A1:F{ws.max_row}"


def count_hallucinations(input_ws: Worksheet, sid: str) -> int:
    hdr = [c.value for c in input_ws[1]]
    try:
        hi = hdr.index(HALLUCINATION_COL_NAME)
    except ValueError:
        return 0
    return sum(
        1
        for row in input_ws.iter_rows(min_row=2, values_only=True)
        if row[0] == sid and row[hi]
    )


def add_hallucination_column(metrics_ws: Worksheet, input_ws: Worksheet) -> None:
    fill = PatternFill("solid", fgColor="00FFFF")
    col = metrics_ws.max_column + 1
    metrics_ws.cell(1, col, HALLUCINATION_COL_NAME).font = Font(name="Aptos", size=9, bold=True)
    for r in range(2, metrics_ws.max_row + 1):
        if metrics_ws.cell(r, 3).value == ENTIRE_COL_NAME:
            sid = metrics_ws.cell(r, 2).value
            v = count_hallucinations(input_ws, sid)
            c = metrics_ws.cell(r, col, v)
            c.font = Font(name="Aptos", size=9)
            c.alignment = Alignment("left", "center")
            c.fill = fill
            c.border = thin_border
        else:
            # still create the cell so columns align, but no fill
            metrics_ws.cell(r, col, None).font = Font(name="Aptos", size=9)
    metrics_ws.column_dimensions[get_column_letter(col)].width = 12
    metrics_ws.auto_filter.ref = f"A1:{get_column_letter(col)}{metrics_ws.max_row}"


def calculate_hallucination_stats(metrics_ws: Worksheet) -> tuple[int, float]:
    hdr = [c.value for c in metrics_ws[1]]
    hi = hdr.index(HALLUCINATION_COL_NAME)
    vals = [
        row[hi]
        for row in metrics_ws.iter_rows(min_row=2, values_only=True)
        if row[2] == ENTIRE_COL_NAME and isinstance(row[hi], (int, float))
    ]
    total = sum(vals)
    cnt   = len(vals)
    return total, (total / cnt if cnt else 0.0)


def calculate_mean_wer(metrics_ws: Worksheet) -> float:
    vals = [
        row[5]
        for row in metrics_ws.iter_rows(min_row=2, values_only=True)
        if row[2] == ENTIRE_COL_NAME and isinstance(row[5], (int, float))
    ]
    return sum(vals) / len(vals) if vals else 0.0


def add_summary_sheet(wb: Workbook) -> Worksheet:
    if SUMMARY_WORKSHEET_NAME in wb.sheetnames:
        del wb[SUMMARY_WORKSHEET_NAME]
    return wb.create_sheet(SUMMARY_WORKSHEET_NAME)


def write_summary(metrics_ws: Worksheet, summary_ws: Worksheet) -> None:
    headers = [
        METADATA_COL_NAME,
        AVERAGE_WER_COL_NAME,
        SESSION_COUNT_COL_NAME,
        HALLUCINATION_COUNT_COL_NAME,
        HALLUCINATION_AVG_COL_NAME
    ]
    for i, title in enumerate(headers, start=1):
        c = summary_ws.cell(1, i, title)
        c.font = Font(name="Aptos", size=11, bold=True)
        c.alignment = Alignment("left", "center")

    meta = metrics_ws.cell(2, 1).value
    mean = calculate_mean_wer(metrics_ws)
    total_h, avg_h = calculate_hallucination_stats(metrics_ws)
    sessions = sum(
        1
        for r in metrics_ws.iter_rows(min_row=2, values_only=True)
        if r[2] == ENTIRE_COL_NAME
    )

    summary_ws.append([meta, mean, sessions, total_h, round(avg_h, 2)])
    summary_ws.cell(2, 2).number_format = "0.00"

    for c in summary_ws[2]:
        c.font = Font(name="Aptos", size=11)
        c.alignment = Alignment("left", "center")

    col_widths = {"A":30, "B":13, "C":16, "D":22, "E":19}
    for col, w in col_widths.items():
        summary_ws.column_dimensions[col].width = w


def get_monthly_filepath(
    root_dir: str,
    metrics_files: list[str],
    prefix: str
) -> tuple[str, str, str, str]:
    dates = []
    for path in metrics_files:
        base = os.path.basename(path).rsplit(".", 1)[0]
        parts = base.split("_")
        rng, year = parts[1], parts[2]
        start, end = rng.split("thru")
        dates.append((start, end, year))
    earliest = min(d[0] for d in dates)
    latest   = max(d[1] for d in dates)
    year     = dates[0][2]
    filename = f"{prefix}_{earliest}thru{latest}_{year}_monthly_metrics.xlsx"
    return os.path.join(root_dir, filename), earliest, latest, year


def create_monthly_worksheet(
    root_dir: str,
    metrics_files: list[str],
    prefix: str
) -> str:
    monthly_path, earliest, latest, year = get_monthly_filepath(root_dir, metrics_files, prefix)
    if os.path.exists(monthly_path):
        os.remove(monthly_path)

    wb = Workbook()
    del wb[wb.sheetnames[0]]

    # aggregate metrics
    mon_metrics = wb.create_sheet(METRICS_WORKSHEET_NAME)
    first = True
    for mf in metrics_files:
        wbf = load_workbook(mf)
        wsf = wbf[METRICS_WORKSHEET_NAME]
        for i, row in enumerate(wsf.iter_rows(values_only=True), start=1):
            if i == 1 and not first:
                continue
            mon_metrics.append(row)
        first = False

    # style and format WER
    for c in mon_metrics[1]:
        c.font = Font(name="Aptos", size=9, bold=True)
        c.alignment = Alignment("left", "center")
    mon_metrics.freeze_panes = "A2"
    mon_metrics.auto_filter.ref = f"A1:{get_column_letter(mon_metrics.max_column)}{mon_metrics.max_row}"
    for col, w in {"A":27, "B":65, "C":9, "D":63, "E":63, "F":8, "G":12}.items():
        mon_metrics.column_dimensions[col].width = w
    for r in mon_metrics.iter_rows(min_row=2):
        cell = r[5]
        cell.number_format = "0.00"

    # highlight ENTIRE rows
    fill = PatternFill("solid", fgColor="00FFFF")
    for row in mon_metrics.iter_rows(min_row=2):
        if row[2].value == ENTIRE_COL_NAME:
            for c in row:
                c.fill = fill
                c.border = thin_border

    # aggregate summary
    mon_sum = wb.create_sheet(SUMMARY_WORKSHEET_NAME)
    first = True
    for mf in metrics_files:
        wbf = load_workbook(mf)
        wsf = wbf[SUMMARY_WORKSHEET_NAME]
        for i, row in enumerate(wsf.iter_rows(values_only=True), start=1):
            if i == 1 and not first:
                continue
            mon_sum.append(row)
        first = False

    for c in mon_sum[1]:
        c.font = Font(name="Aptos", size=9, bold=True)
        c.alignment = Alignment("left", "center")
    mon_sum.freeze_panes = "A2"
    mon_sum.auto_filter.ref = f"A1:{get_column_letter(mon_sum.max_column)}{mon_sum.max_row}"
    for col, w in {"A":36, "B":11, "C":14, "D":19, "E":17}.items():
        mon_sum.column_dimensions[col].width = w

    # consolidated summary row
    mon_sum.append([None] * 5)
    entries = list(mon_sum.iter_rows(min_row=2, max_row=1+len(metrics_files), values_only=True))
    avg_wers = [r[1] for r in entries]
    num_sess = sum(int(r[2]) for r in entries)
    total_h  = sum(int(r[3]) for r in entries)
    avg_h    = round(total_h / num_sess, 2) if num_sess else 0.0

    meta_lbl = f"{prefix}_{earliest}thru{latest}_{year}"
    mon_sum.append([meta_lbl,
                    round(sum(avg_wers) / len(avg_wers), 2) if avg_wers else 0.0,
                    num_sess,
                    total_h,
                    avg_h])

    last = mon_sum.max_row
    fill_con = PatternFill("solid", fgColor="00FFFF")
    for row in mon_sum.iter_rows(min_row=1, max_row=last):
        for c in row:
            c.font = Font(name="Aptos", size=9, bold=(c.row == 1))
            if c.row == last:
                c.fill = fill_con
                c.border = thin_border

    wb.save(monthly_path)
    return monthly_path


def main() -> None:
    input_files = list_input_spreadsheets(ROOT_DIR)
    metrics_files: list[str] = []

    for inp in input_files:
        wb_in = load_workbook(inp)
        ws_name = next(n for n in wb_in.sheetnames if n.startswith(WORKSHEET_PREFIX))
        in_ws = wb_in[ws_name]

        out_path = get_name_of_results_spreadsheet(inp)
        if os.path.exists(out_path):
            os.remove(out_path)

        wb_out = Workbook()
        copy_ws = wb_out.active
        copy_ws.title = ws_name
        for row in in_ws.iter_rows(values_only=True):
            copy_ws.append(row)

        mws = add_metrics_sheet(wb_out)
        write_header(mws)
        md = os.path.basename(inp).rsplit(".", 1)[0]
        process_sessions(in_ws, mws, md)
        style_columns(mws)
        add_hallucination_column(mws, in_ws)

        sws = add_summary_sheet(wb_out)
        write_summary(mws, sws)

        wb_out.save(out_path)
        print(f"Saved metrics & summary to {out_path}")
        metrics_files.append(out_path)

    if DO_MONTHLY_CONSOLIDATION and metrics_files:
        mon_path = create_monthly_worksheet(ROOT_DIR, metrics_files, SPREADSHEET_PREFIX)
        print(f"Saved monthly consolidated metrics to {mon_path}")


if __name__ == "__main__":
    main()